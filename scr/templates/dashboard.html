{% extends "base.html" %}

{% block title %}Mi Cuenta - {{ section_title }}{% endblock %}

{% block content %}

    <div class="container account-panel-container">
        <h1>Mi Cuenta</h1>
        
        <div class="panel-layout">
            
            {# ========================================== #}
            {# MEN√ö LATERAL DE NAVEGACI√ìN #}
            {# ========================================== #}
            <aside class="account-sidebar">
                <h3>Opciones de Cuenta</h3>
                <ul class="panel-nav-list">
                    <li>
                        {# Enlace a la gesti√≥n de perfil/direcciones #}
                        <a href="{{ url_for('administrar_cuenta') }}" class="{% if active_tab == 'perfil' %}active{% endif %}">
                            ‚öôÔ∏è Administrar Cuenta
                        </a>
                    </li>
                    <li>
                        {# Enlace a la lista de pedidos #}
                        <a href="{{ url_for('rastrear_pedidos') }}" class="{% if active_tab == 'pedidos' %}active{% endif %}">
                            üì¶ Rastrear Pedidos
                        </a>
                    </li>
                    <li>
                        {# Enlace a las facturas/historial de pagos #}
                        <a href="{{ url_for('ver_facturas') }}" class="{% if active_tab == 'facturas' %}active{% endif %}">
                            üßæ Facturas y Pagos
                        </a>
                    </li>
                    <hr>
                    <li>
                        <a href="{{ url_for('logout') }}" class="logout-link">
                            ‚û°Ô∏è Cerrar Sesi√≥n
                        </a>
                    </li>
                </ul>
            </aside>

            {# ========================================== #}
            {# CONTENIDO DIN√ÅMICO DE LA SECCI√ìN (MAIN √öNICO) #}
            {# ========================================== #}
            <main class="panel-content">
                <h2>{{ section_title }}</h2>
                
                {# Contenido espec√≠fico para ADMINISTRAR CUENTA #}
                {% if active_tab == 'perfil' %}
                    <div class="container">
                        <h1>Administrar Mi Cuenta</h1>
                        <p>Actualiza tus datos personales y tu direcci√≥n.</p>

                        <form action="" method="POST" style="max-width: 600px; margin-top: 25px;">

                            <h2>Datos Personales</h2>

                            <label>Nombre Completo:</label>
                            <input type="text" name="nombre" value="{{ usuario.nombre }}" required class="input">

                            <label>Correo Electr√≥nico:</label>
                            <input type="email" name="email" value="{{ usuario.email }}" required class="input" disabled>

                            <label>Tel√©fono:</label>
                            <input type="text" name="telefono" value="{{ usuario.telefono }}" class="input">

                            <hr style="margin: 25px 0;">

                            <h2>Direcci√≥n</h2>

                            <label>Nombre de direcci√≥n (Casa, Trabajo, etc):</label>
                            <input type="text" name="nombre_direccion" value="{{ direccion.nombre_direccion }}" class="input">

                            <label>Direcci√≥n:</label>
                            <input type="text" name="linea1" value="{{ direccion.linea1 }}" required class="input">

                            <label>Ciudad:</label>
                            <input type="text" name="ciudad" value="{{ direccion.ciudad }}" required class="input">

                            <label>Pa√≠s:</label>
                            <input type="text" name="pais" value="{{ direccion.pais }}" required class="input">

                            <label>C√≥digo Postal:</label>
                            <input type="text" name="codigo_postal" value="{{ direccion.codigo_postal }}" class="input">

                            <button type="submit" class="cta-button" style="margin-top:20px;">
                                Guardar Cambios
                            </button>
                        </form>
                    </div>

                {# Contenido espec√≠fico para RASTREAR PEDIDOS #}
                {% elif active_tab == 'pedidos' %}
                    {% if pedidos %}
                        <div class="pedidos-list">
                            {% for pedido in pedidos %}
                            <div class="pedido-card">
                                <div class="pedido-header">
                                    <span class="pedido-id">Pedido #{{ pedido.id }}</span>
                                    <span class="estado {{ pedido.estado | replace(' ', '') | lower }}">{{ pedido.estado }}</span>
                                </div>

                                <div class="pedido-summary">
                                    <p><strong>Fecha:</strong> {{ pedido.fecha_creacion.strftime('%d/%m/%Y %H:%M') }}</p>
                                    <p><strong>Total:</strong> <span class="pedido-total">${{ "%.2f"|format(pedido.total) }}</span></p>

                                    {% if pedido.numero_rastreo %}
                                        <p><strong>Rastreo:</strong> <span class="tracking-number">{{ pedido.numero_rastreo }}</span></p>
                                        <p><strong>Transportadora:</strong> {{ pedido.proveedor_logistico }}</p>
                                    {% else %}
                                        <p class="no-tracking"><em>Este pedido a√∫n no tiene n√∫mero de rastreo.</em></p>
                                    {% endif %}
                                </div>

                                <div class="detalle">
                                    <h4>Productos:</h4>
                                    <div class="detalle-items-list">
                                        {% for item in pedido.detalles %}
                                            <p class="detalle-item">
                                                {{ item.producto.nombre }} (x{{ item.cantidad }}) ‚Äî ${{ "%.2f"|format(item.precio_unitario) }}
                                            </p>
                                        {% endfor %}
                                    </div>
                                </div>

                                <a href="" class="cta-button mini-button">
                                    Ver Detalles
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="no-pedidos">
                            <h3>No tienes pedidos a√∫n üò•</h3>
                            <p>Cuando compres algo, aparecer√° aqu√≠. ¬°Explora nuestro <a href="{{ url_for('catalogo') }}">cat√°logo</a>!</p>
                        </div>
                    {% endif %}

                {# Contenido espec√≠fico para FACTURAS Y PAGOS #}
                {% elif active_tab == 'facturas' %}
                    {% if facturas %}
                        <div class="facturas-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID Transacci√≥n</th>
                                        <th>Fecha</th>
                                        <th>Monto Total</th>
                                        <th>Estado Pedido</th>
                                        <th>Estado Pago</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    {% for f in facturas %}
                                    <tr>
                                        <td data-label="ID">{{ f.id }}</td>
                                        <td data-label="Fecha">{{ f.fecha_creacion.strftime("%Y-%m-%d") }}</td>
                                        <td data-label="Total" class="total">${{ "%.2f"|format(f.total) }}</td>
                                        <td data-label="Estado Pedido">
                                            <span class="status-tag pedido-{{ f.estado | replace(' ', '') | lower }}">{{ f.estado }}</span>
                                        </td>
                                        <td data-label="Pago">
                                            <span class="status-tag pago-{{ f.estado_pago | lower }}">{{ f.estado_pago }}</span>
                                        </td>
                                        <td data-label="Ver">
                                            <a href="/factura/{{ f.id }}" target="_blank" class="cta-button mini-button fact-button">
                                                Descargar PDF
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="no-pedidos">
                            <h3>No hay facturas disponibles</h3>
                            <p>Las facturas se generan al confirmar el pago de un pedido.</p>
                        </div>
                    {% endif %}

                {% else %}
                    <p>Selecciona una opci√≥n del men√∫ lateral para comenzar.</p>
                {% endif %}
                
            </main>
        </div>
    </div>
{% endblock %}